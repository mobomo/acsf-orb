description: >
  Deploys a tag to Acquia Site Factory env using its API.
parameters:
  tag:
    type: string
    default: build-v1.0.${CIRCLE_BUILD_NUM}
    description: 'The tag to deploy.'
  env:
    type: enum
    enum: [ 'dev', 'test', 'prod' ]
    default: 'dev'
    description: 'The environment where to deploy.'
  deploy-type:
    type: enum
    enum: [ 'code', 'code, db']
    default: 'code, db'
    description: 'The type of deployment either Code Only or Code and Database.'
  acsf-user:
    type: string
    default: ''
    description: 'The Acquia Site Factory username.'
  acsf-key:
    type: string
    default: ''
    description: 'The Acquia Site Factory user key.'
  acsf-site:
    type: string
    default: ''
    description: 'The Acquia Site Factory project site name.'
steps:
  - run:
      name: Deployment to ACSF
      command: |
        TAG_TO_DEPLOY=<< parameters.tag >>
        if [ -n ${TAG_TO_DEPLOY} ]; then
          echo Deploying ${TAG_TO_DEPLOY} to ACSF << parameters.env >>...
          curl 'https://www.<< parameters.env >>-<< parameters.acsf-site >>.acsitefactory.com/api/v1/update' \
            -v -u << parameters.acsf-user >>:<< parameters.acsf-key >> -X POST \
            -H 'Content-Type: application/json' \
            -d '{"scope": "sites", "sites_ref": "tags/'"${TAG_TO_DEPLOY}"'", "sites_type": "<< parameters.deploy-type >>", "stack_id": 1}'
        else
          echo "We didn't get any release tag to deploy. Please check your Job and make sure you are setting a tag param."
        fi
