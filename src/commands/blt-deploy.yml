description: >
  Deploys a tag to Acquia Site Factory env using its API.
parameters:
  tag:
    type: string
    default: build-v1.0.${CIRCLE_BUILD_NUM}
    description: 'The tag to deploy.'
  env:
    type: enum
    enum: [ 'dev', 'test', 'prod' ]
    default: 'dev'
    description: 'The environment where to deploy.'
  deploy-type:
    type: enum
    enum: [ 'code', 'code, db']
    default: 'code, db'
    description: 'The type of deployment either Code Only or Code and Database.'
  acsf-user:
    type: string
    default: ''
    description: 'The Acquia Site Factory username.'
  acsf-site:
    type: string
    default: ''
    description: 'The Acquia Site Factory project site name.'
steps:
  - run:
      name: Deployment to ACSF
      command: |
        TAG_TO_DEPLOY=<< parameters.tag >>
        ACSF_ENV=<< parameters.env >>
        if [ -n ${ACQUIA_KEY_DEV} && -n ${ACQUIA_KEY_TEST} ]; then
          case $ACSF_ENV in
            dev)
                ACQUIA_KEY=${ACQUIA_KEY_DEV};;
            test)
                ACQUIA_KEY=${ACQUIA_KEY_TEST};;
            *)
                ACQUIA_KEY=""
                echo "$ACSF_ENV not supported.";;
          esac
        else
          echo "Please set your ACSF User key as an env variable for all your envs."
        fi
        if [ -n ${TAG_TO_DEPLOY} && -n ${ACQUIA_KEY} ]; then
          echo Deploying ${TAG_TO_DEPLOY} to ACSF << parameters.env >>...
          curl 'https://www.<< parameters.env >>-<< parameters.acsf-site >>.acsitefactory.com/api/v1/update' \
            -v -u << parameters.acsf-user >>:${ACQUIA_KEY} -X POST \
            -H 'Content-Type: application/json' \
            -d '{"scope": "sites", "sites_ref": "tags/'"${TAG_TO_DEPLOY}"'", "sites_type": "<< parameters.deploy-type >>", "stack_id": 1}'
        else
          printf "ERROR: tag and ACQUIA_KEY_[ENV] env variable are required. \nPlease make sure your job is passing the required params and you have setup the environment variables\n"
        fi
