description: >
  Build and Deploy to ACSF

executor: default

parameters:
  env_fingerprints:
    type: string
    default: ""
    description: "Environment fingerprints"
  git_fingerprints:
    type: string
    default: ""
    description: "Git fingerprints"
  acquia_key:
    type: string
    default: ""
    description: "Acquia Environment Key"
  slack_channel:
    type: string
    default: ""
    description: "Slack Channel"
environment:
  BASH_ENV: /etc/profile
steps:
  - run:
      name: Setup Environment Variables
      command: |
        echo "export PATH=`pwd`/vendor/bin:$PATH" >> $BASH_ENV
        source $BASH_ENV
  - checkout
  - restore_cache:
      keys:
        - composer-cache
  - restore_cache:
      keys:
        - composer-mbn-{{ checksum "composer.lock" }}
  - add_ssh_keys:
      fingerprints:
          - "<<parameters.env_fingerprints>>"
  - run:
      name: SSH Disable Host Key Checking
      command: |
        echo "StrictHostKeyChecking=no">> ~/.ssh/config
  - run:
      name: BLT build
      command: |
        vendor/bin/blt artifact:deploy \
          --environment ci \
          --commit-msg "Nightly Build - ${CIRCLE_BUILD_NUM}" \
          --branch "nightly-build" \
          --tag "build-v1.${CIRCLE_BUILD_NUM}" \
          --ignore-dirty \
          --no-interaction \
          --verbose
  - run:
      name: Deploy to Dev
      command: |
        curl 'https://www.dev-mbn.acsitefactory.com/api/v1/update' \
        -v -u mbnacsfapi:<<parameters.acquia_key>> -X POST \
        -H 'Content-Type: application/json' \
        -d '{"scope": "sites", "sites_ref": "tags/build-v1.'"${CIRCLE_BUILD_NUM}"'", "sites_type": "code, db", "stack_id": 1}'
  - run:
      name: "Create release on Jira"
      command: |
        NOW=$(date +"%Y-%m-%d")
        TAG=build-v1.0."${CIRCLE_BUILD_NUM}"
        curl -X POST -H "Authorization: Basic ${JIRAAUTH}" \
                      -H "Content-Type: application/json" \
        --data '{"name": "'"${TAG}"'","startDate": "'"${NOW}"'","project": "MBN", "released": false}' \
        https://intridea.atlassian.net/rest/api/2/version
  - add_ssh_keys:
      fingerprints:
        - "<<parameters.git_fingerprints>>"
  - run:
      name: Git Publisher
      command: |
        TAG=build-v1.0."${CIRCLE_BUILD_NUM}"
        git config --global user.name "CCI Automation"
        git config --global user.email "dp_admin@mobomo.com"
        git tag -a ${TAG} -m "Circle CI Deploy to Dev"
        git push origin ${TAG}
  - slack/notify:
      event: pass
      channel: <<parameters.slack_channel>>
      template: success_tagged_deploy_1

